{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>Admin Panel</h2>

    <div style="margin-bottom: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px;">
        <h3>Change My Password</h3>
        <form method="POST" action="{{ url_for('admin.change_password') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label>Current Password</label>
                <input type="password" name="current_password" required>
            </div>
            <div class="form-group">
                <label>New Password</label>
                <input type="password" name="new_password" required>
            </div>
            <button type="submit" class="btn btn-primary">Change Password</button>
        </form>
    </div>

    <div style="margin-bottom: 30px;">
        <h3>Create User</h3>
        <form method="POST" action="{{ url_for('admin.create_user') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label>Username</label>
                <input type="text" name="username" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" name="password" required>
            </div>
            <div class="form-group">
                <label>Quota (GB)</label>
                <input type="number" name="quota_gb" value="1" min="1" required>
            </div>
            <button type="submit" class="btn btn-primary">Create User</button>
        </form>
    </div>

    <h3>Users</h3>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Usage / Quota</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.username }} {% if user.is_admin %}(Admin){% endif %}</td>
                <td>{{ (user.used_bytes / 1024 / 1024)|round(2) }} MB / {{ (user.quota_bytes / 1024 / 1024 /
                    1024)|round(2) }} GB</td>
                <td>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <form action="{{ url_for('admin.update_quota', user_id=user.id) }}" method="POST"
                            style="display: flex; gap: 5px;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="number" name="quota_gb"
                                value="{{ (user.quota_bytes / 1024 / 1024 / 1024)|int }}"
                                style="width: 60px; padding: 4px;" min="1">
                            <button type="submit" class="btn btn-secondary"
                                style="padding: 4px 8px; font-size: 12px;">Set GB</button>
                        </form>

                        {% if user.id != current_user.id %}
                        <form action="{{ url_for('admin.toggle_admin', user_id=user.id) }}" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit"
                                class="btn {% if user.is_admin %}btn-danger{% else %}btn-primary{% endif %}"
                                style="padding: 4px 8px; font-size: 12px;">
                                {% if user.is_admin %}Revoke Admin{% else %}Make Admin{% endif %}
                            </button>
                        </form>

                        <form action="{{ url_for('admin.delete_user', user_id=user.id) }}" method="POST"
                            onsubmit="return confirm('Are you sure you want to delete this user? All their files will be permanently deleted.');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-danger"
                                style="padding: 4px 8px; font-size: 12px;">Delete User</button>
                        </form>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}