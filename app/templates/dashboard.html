{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>My Files</h2>

    <div class="section-row">
        <div class="breadcrumbs">
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">Home</a>
            {% for crumb in breadcrumbs %}
            <span style="color: #888; font-size: 1.2em;">/</span>
            <a href="{{ url_for('main.dashboard', path=crumb.path) }}"
                style="text-decoration: none; color: #007bff; font-weight: bold;">{{ crumb.name }}</a>
            {% endfor %}
        </div>
        <button class="btn btn-secondary"
            onclick="document.getElementById('create-folder-modal').style.display='block'">New Folder</button>
    </div>

    <div style="margin-bottom: 20px;">
        <strong>Storage Usage:</strong> {{ user.used_bytes|format_size }} / {{ user.quota_bytes|format_size }}
        <div class="quota-bar">
            <div class="quota-fill" style="width: {{ (user.used_bytes / user.quota_bytes * 100)|round(2) }}%"></div>
        </div>
    </div>

    <form id="upload-form" class="upload-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
            <label for="file">Upload Files</label>
            <input type="file" id="file" name="file" multiple required>
            <input type="hidden" name="current_path" value="{{ current_path }}">
        </div>
        <div class="upload-actions">
            <button type="submit" class="btn btn-primary" id="upload-btn">Upload</button>
            <button type="button" class="btn btn-danger" id="cancel-btn" style="display: none;">Cancel</button>
        </div>
    </form>

    <!-- Upload Progress -->
    <div id="upload-progress" style="display: none; margin-top: 20px;">
        <div style="margin-bottom: 10px;">
            <strong>Current File:</strong> <span id="current-filename"></span><br>
            <strong>Progress:</strong> <span id="progress-percent">0</span>%
            (<span id="files-processed">0</span>/<span id="total-files">0</span> files)
        </div>
        <div class="quota-bar">
            <div id="progress-bar" class="quota-fill" style="width: 0%; background-color: #4CAF50;"></div>
        </div>
        <div style="margin-top: 10px;">
            <strong>Speed:</strong> <span id="upload-speed">0</span> Mbps
        </div>
    </div>

    <div class="table-wrap">
    <table>
        <thead>
            <tr>
                <th>Filename</th>
                <th>Size</th>
                <th>Share</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for file in files %}
            <tr>
                <td>
                    {% if file.type == 'folder' %}
                    <span style="font-size: 20px; margin-right: 5px;">üìÅ</span>
                    <a href="{{ url_for('main.dashboard', path=file.path) }}">{{ file.name }}</a>
                    {% else %}
                    <span style="font-size: 20px; margin-right: 5px;">üìÑ</span>
                    {{ file.name }}
                    {% endif %}
                </td>
                <td>
                    {% if file.type == 'folder' %}
                    -
                    {% else %}
                    {{ file.size|format_size }}
                    {% endif %}
                </td>
                <td>
                    {% if file.type != 'folder' %}
                    <div class="actions-group" style="align-items: center;">
                        <div class="actions-group" style="align-items: center;">
                            <input type="checkbox" id="share-{{ loop.index }}" {% if file.share_token %}checked{% endif
                                %} onchange="toggleShare('{{ file.name }}', this.checked)" style="cursor: pointer;">
                            <label for="share-{{ loop.index }}"
                                style="margin: 0; cursor: pointer; font-size: 12px;">Share</label>
                        </div>

                        {% if file.share_token %}
                        <button
                            onclick="copyShareLink('{{ url_for('main.public_download', token=file.share_token, _external=True) }}')"
                            class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;">Copy Link</button>
                        {% endif %}
                    </div>
                    {% endif %}
                </td>
                <td>
                    <div class="actions-group">
                        {% if file.type != 'folder' %}
                        <a href="{{ url_for('main.download_file', filename=file.name) }}" class="btn btn-primary"
                            style="padding: 4px 8px; font-size: 12px;">Download</a>

                        {% if file.name.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.bmp', '.svg', '.webp',
                        '.mp4', '.webm', '.ogg', '.mov', '.mp3', '.wav', '.m4a', '.zip')) %}
                        <button onclick="previewFile('{{ file.name }}', '{{ file.path }}')" class="btn btn-info"
                            style="padding: 4px 8px; font-size: 12px; background-color: #8A2BE2; border-color: #8A2BE2; color: white;">Preview</button>
                        {% endif %}

                        <form action="{{ url_for('main.delete_file', filename=file.name) }}" method="POST"
                            style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;"
                                onclick="return confirm('Are you sure?')">Delete</button>
                        </form>
                        {% else %}
                        <!-- Folder Actions -->
                        <form action="{{ url_for('main.delete_folder') }}" method="POST" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="folder_path" value="{{ file.path }}">
                            <input type="hidden" name="current_path" value="{{ current_path }}">
                            <button type="submit" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;"
                                onclick="return confirm('Are you sure you want to delete this folder and all its contents?')">Delete</button>
                        </form>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" style="text-align: center;">No files uploaded yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>

<script>
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    let isUploading = false;
    let abortController = null;
    let currentUploadId = null;

    window.onbeforeunload = function () {
        if (isUploading) {
            return "Upload in progress. Are you sure you want to leave? Your upload will be cancelled.";
        }
    };

    async function toggleShare(filename, shouldShare) {
        try {
            const formData = new FormData();
            formData.append('csrf_token', csrfToken);

            const url = shouldShare
                ? `/share/${encodeURIComponent(filename)}`
                : `/unshare/${encodeURIComponent(filename)}`;

            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            const result = await response.json();
            if (result.status === 'success') {
                if (shouldShare && result.url) {
                    const message = `Share link generated:\n${result.url}\n\nYou can copy it using the "Copy Link" button.`;
                    alert(message);
                }
                location.reload();
            } else {
                alert('Error: ' + result.message);
                location.reload();
            }
        } catch (e) {
            alert('Error: ' + e.message);
            location.reload();
        }
    }

    function copyShareLink(url) {
        navigator.clipboard.writeText(url).then(() => {
            alert('Link copied to clipboard!');
        });
    }

    document.getElementById('upload-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        if (isUploading) return;

        const fileInput = document.getElementById('file');
        const files = Array.from(fileInput.files);

        if (files.length === 0) {
            alert('Please select files');
            return;
        }

        isUploading = true;
        abortController = new AbortController();

        const progressDiv = document.getElementById('upload-progress');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const uploadSpeed = document.getElementById('upload-speed');
        const uploadBtn = document.getElementById('upload-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const currentFilenameSpan = document.getElementById('current-filename');
        const filesProcessedSpan = document.getElementById('files-processed');
        const totalFilesSpan = document.getElementById('total-files');

        progressDiv.style.display = 'block';
        uploadBtn.disabled = true;
        cancelBtn.style.display = 'inline-block';
        filesProcessedSpan.textContent = '0';
        totalFilesSpan.textContent = files.length;

        const CHUNK_SIZE = 2 * 1024 * 1024;
        const MAX_RETRIES = 3;

        try {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                currentFilenameSpan.textContent = file.name;
                filesProcessedSpan.textContent = i + 1;

                progressBar.style.width = '0%';
                progressPercent.textContent = '0';

                const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
                currentUploadId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                let chunksUploaded = 0;
                let lastUpdateTime = Date.now();
                let lastLoadedBytes = 0;
                const speedReadings = [];

                for (let chunkIdx = 0; chunkIdx < totalChunks; chunkIdx++) {
                    if (abortController.signal.aborted) throw new Error('Cancelled');

                    const start = chunkIdx * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, file.size);
                    const chunk = file.slice(start, end);

                    const formData = new FormData();
                    formData.append('file', chunk);
                    formData.append('upload_id', currentUploadId);
                    formData.append('chunk_index', chunkIdx);
                    formData.append('csrf_token', csrfToken);

                    let uploaded = false;
                    for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                        try {
                            const response = await fetch('{{ url_for("main.upload_chunk") }}', {
                                method: 'POST',
                                body: formData,
                                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                                signal: abortController.signal
                            });

                            if (!response.ok) {
                                const res = await response.json();
                                throw new Error(res.message || `HTTP ${response.status}`);
                            }
                            uploaded = true;
                            break;
                        } catch (err) {
                            if (attempt === MAX_RETRIES - 1 || abortController.signal.aborted) throw err;
                            await new Promise(r => setTimeout(r, 1000 * (attempt + 1)));
                        }
                    }

                    chunksUploaded++;

                    const percent = (chunksUploaded / totalChunks) * 100;
                    progressBar.style.width = percent + '%';
                    progressPercent.textContent = percent.toFixed(1);

                    const now = Date.now();
                    const timeDiff = (now - lastUpdateTime) / 1000;
                    if (timeDiff >= 0.5 || chunkIdx === totalChunks - 1) {
                        const loaded = Math.min((chunkIdx + 1) * CHUNK_SIZE, file.size);
                        const bytesDiff = loaded - lastLoadedBytes;
                        const speedMbps = (bytesDiff * 8) / (1024 * 1024) / timeDiff;

                        speedReadings.push(speedMbps);
                        if (speedReadings.length > 5) speedReadings.shift();
                        const avgSpeed = speedReadings.reduce((a, b) => a + b, 0) / speedReadings.length;

                        uploadSpeed.textContent = avgSpeed.toFixed(2);
                        lastUpdateTime = now;
                        lastLoadedBytes = loaded;
                    }
                }

                if (abortController.signal.aborted) throw new Error('Cancelled');

                const mergeData = new FormData();
                mergeData.append('upload_id', currentUploadId);
                const currentPathInput = document.querySelector('#upload-form input[name="current_path"]');
                mergeData.append('current_path', currentPathInput ? currentPathInput.value : '');
                mergeData.append('filename', file.name);
                mergeData.append('total_chunks', totalChunks);
                mergeData.append('csrf_token', csrfToken);

                const mergeRes = await fetch('{{ url_for("main.upload_merge") }}', {
                    method: 'POST',
                    body: mergeData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    signal: abortController.signal
                });

                if (!mergeRes.ok) {
                    const res = await mergeRes.json();
                    throw new Error(res.message || 'Merge failed');
                }
            }

            // Clear file input
            fileInput.value = '';

            // Force reload
            isUploading = false;
            window.location.href = window.location.href;

        } catch (error) {
            if (error.message === 'Cancelled') {
                console.log('Upload cancelled');
            } else {
                alert('Upload failed: ' + error.message);
            }
        } finally {
            isUploading = false;
            uploadBtn.disabled = false;
            cancelBtn.style.display = 'none';
            progressDiv.style.display = 'none';
            currentUploadId = null;
        }
    });

    document.getElementById('cancel-btn').addEventListener('click', async function () {
        if (!isUploading) return;

        if (confirm('Are you sure you want to cancel the upload?')) {
            abortController.abort();
            isUploading = false;

            if (currentUploadId) {
                const formData = new FormData();
                formData.append('upload_id', currentUploadId);
                formData.append('csrf_token', csrfToken);

                try {
                    await fetch('{{ url_for("main.upload_cancel") }}', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });
                } catch (e) {
                    console.error('Cleanup failed', e);
                }
            }

            document.getElementById('upload-progress').style.display = 'none';
            document.getElementById('upload-btn').disabled = false;
            this.style.display = 'none';
        }
    });

    async function previewFile(filename, filepath) {
        const modal = document.getElementById('preview-modal');
        const content = document.getElementById('preview-content');
        const title = document.getElementById('preview-title');

        title.textContent = 'Preview: ' + filename;
        content.innerHTML = 'Loading...';
        modal.style.display = 'block';

        const ext = filename.split('.').pop().toLowerCase();

        // Use filepath for the download URL to ensure subfolders work. Add preview=true to force inline display.
        const downloadUrl = `/download/${encodeURIComponent(filepath)}?preview=true`;

        if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg', 'webp'].includes(ext)) {
            content.innerHTML = `<img src="${downloadUrl}" style="max-width: 100%; max-height: 500px;">`;
        } else if (['mp4', 'webm', 'ogg', 'mov'].includes(ext)) {
            let mimeType = 'video/mp4';
            if (ext === 'webm') mimeType = 'video/webm';
            if (ext === 'ogg') mimeType = 'video/ogg';
            // mov is often not supported purely by html5 video without codecs info, but we can try generic video/mp4 or letting browser sniff

            content.innerHTML = `
                <video controls style="max-width: 100%; max-height: 500px;" autoplay>
                    <source src="${downloadUrl}" type="${mimeType}">
                    Your browser does not support the video tag.
                </video>`;
        } else if (['mp3', 'wav', 'm4a'].includes(ext)) {
            content.innerHTML = `
                <audio controls style="width: 100%;">
                    <source src="${downloadUrl}">
                    Your browser does not support the audio element.
                </audio>`;
        } else if (ext === 'zip') {
            try {
                const response = await fetch(`/preview/zip/${encodeURIComponent(filepath)}`);
                const result = await response.json();

                if (result.status === 'success') {
                    const ul = document.createElement('ul');
                    ul.style.textAlign = 'left';
                    ul.style.maxHeight = '400px';
                    ul.style.overflowY = 'auto';

                    result.contents.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        ul.appendChild(li);
                    });

                    content.innerHTML = '';
                    content.appendChild(ul);
                } else {
                    content.innerHTML = 'Error loading preview: ' + result.message;
                }
            } catch (e) {
                content.innerHTML = 'Error loading preview: ' + e.message;
            }
        } else {
            content.innerHTML = 'Preview not available for this file type.';
        }
    }

    window.onclick = function (event) {
        const modal1 = document.getElementById('create-folder-modal');
        const modal2 = document.getElementById('preview-modal');
        if (event.target == modal1) {
            modal1.style.display = "none";
        }
        if (event.target == modal2) {
            modal2.style.display = "none";
        }
    }
</script>

<!-- Create Folder Modal -->
<div id="create-folder-modal" class="modal modal-shell">
    <div class="modal-content modal-content-card">
        <span class="close-x" onclick="document.getElementById('create-folder-modal').style.display='none'">&times;</span>
        <h3>Create New Folder</h3>
        <form action="{{ url_for('main.create_folder') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="current_path" value="{{ current_path }}">
            <div class="form-group">
                <label for="folder_name">Folder Name</label>
                <input type="text" id="folder_name" name="folder_name" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Create</button>
        </form>
    </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="modal modal-shell modal-shell-dark">
    <div class="modal-content modal-content-card modal-content-wide" style="position: relative;">
        <span class="close-x" onclick="document.getElementById('preview-modal').style.display='none'">&times;</span>
        <h3 id="preview-title">Preview</h3>
        <div id="preview-content"
            style="text-align: center; min-height: 200px; display: flex; justify-content: center; align-items: center;">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}
